<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TopLocs Event Plugin - Full System Test</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }
        .success { color: #059669; }
        .error { color: #dc2626; }
        .warning { color: #d97706; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="container mx-auto p-6">
        <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                🏗️ TopLocs Event Plugin System Test
            </h1>
            <p class="text-gray-600">
                Testing the Meetup.com-like features: Groups, Events, RSVP, and Real-time sync
            </p>
        </div>

        <!-- System Overview -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">📊 System Architecture Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-900 mb-2">🔗 Router System</h3>
                    <p class="text-sm text-blue-700">Query-param based routing with {{ routes.length }} routes</p>
                    <div class="text-xs mt-2 space-y-1">
                        <div v-for="route in routes.slice(0, 4)" :key="route.path" class="text-blue-600">
                            {{ route.meta?.icon }} {{ route.path }}
                        </div>
                        <div v-if="routes.length > 4" class="text-blue-500">+{{ routes.length - 4 }} more</div>
                    </div>
                </div>

                <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-green-900 mb-2">👥 Groups System</h3>
                    <p class="text-sm text-green-700">{{ mockGroups.length }} mock groups with {{ categories.length }} categories</p>
                    <div class="text-xs mt-2">
                        <div v-for="cat in categories.slice(0, 3)" :key="cat.id" class="text-green-600">
                            {{ cat.icon }} {{ cat.name }}
                        </div>
                    </div>
                </div>

                <div class="bg-purple-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-purple-900 mb-2">📅 Events System</h3>
                    <p class="text-sm text-purple-700">{{ mockEvents.length }} mock events with RSVP tracking</p>
                    <div class="text-xs mt-2 text-purple-600">
                        <div>• Real-time RSVP updates</div>
                        <div>• Waitlist management</div>
                        <div>• Event status tracking</div>
                    </div>
                </div>

                <div class="bg-yellow-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-yellow-900 mb-2">🔄 P2P Integration</h3>
                    <p class="text-sm text-yellow-700">Gun.js data patterns ready</p>
                    <div class="text-xs mt-2 text-yellow-600">
                        <div>• Distributed data storage</div>
                        <div>• Real-time synchronization</div>
                        <div>• Offline-first architecture</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Test -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">🧭 Navigation & Routing Test</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
                <button v-for="route in routes" :key="route.path"
                        @click="navigateToRoute(route)"
                        :class="[
                            'px-3 py-2 text-sm rounded-md transition-colors',
                            currentRoute === route.path 
                                ? 'bg-blue-500 text-white' 
                                : 'bg-gray-100 hover:bg-gray-200'
                        ]">
                    {{ route.meta?.icon }} {{ route.meta?.title }}
                </button>
            </div>
            <div class="bg-gray-50 p-3 rounded text-sm">
                <strong>Current Route:</strong> {{ currentRoute }} 
                <span v-if="currentQuery" class="ml-2 text-gray-600">
                    Query: {{ JSON.stringify(currentQuery) }}
                </span>
            </div>
        </div>

        <!-- Groups Simulation -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">👥 Groups Management Test</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <div v-for="group in mockGroups" :key="group.id" 
                     class="border rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer"
                     @click="selectGroup(group)">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-2xl">{{ getCategoryIcon(group.category) }}</span>
                        <div>
                            <h3 class="font-medium text-gray-900">{{ group.name }}</h3>
                            <p class="text-sm text-gray-600">{{ group.location.city }}</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-700 mb-2">{{ group.description }}</p>
                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <span>{{ group.memberCount }} members</span>
                        <span :class="group.privacy === 'private' ? 'text-red-600' : 'text-green-600'">
                            {{ group.privacy === 'private' ? '🔒 Private' : '🌍 Public' }}
                        </span>
                    </div>
                </div>
            </div>
            
            <button @click="createMockGroup" 
                    class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                ➕ Create New Group
            </button>
        </div>

        <!-- Events & RSVP System -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">📅 Events & RSVP System Test</h2>
            <div class="space-y-4 mb-4">
                <div v-for="event in mockEvents" :key="event.id"
                     class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-medium text-gray-900">{{ event.title }}</h3>
                                <span v-if="event.groupId" class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded">
                                    {{ getGroupName(event.groupId) }}
                                </span>
                            </div>
                            <p class="text-sm text-gray-700 mb-2">{{ event.description }}</p>
                            <div class="flex items-center gap-4 text-sm text-gray-600">
                                <span>📅 {{ formatDate(event.date) }}</span>
                                <span>👥 {{ getEventAttending(event) }} attending</span>
                                <span v-if="event.limit">📋 {{ event.limit }} max</span>
                                <span v-if="getEventWaitlist(event) > 0" class="text-yellow-600">
                                    ⏳ {{ getEventWaitlist(event) }} waiting
                                </span>
                            </div>
                        </div>
                        
                        <div class="flex flex-col gap-2 ml-4">
                            <button @click="rsvpToEvent(event, 'attending')"
                                    :class="[
                                        'px-3 py-1 text-sm rounded-md transition-colors',
                                        getUserRSVP(event) === 'attending'
                                            ? 'bg-green-500 text-white'
                                            : 'bg-gray-100 hover:bg-gray-200'
                                    ]">
                                {{ getUserRSVP(event) === 'attending' ? '✅ Attending' : 'Attend' }}
                            </button>
                            <button @click="rsvpToEvent(event, 'maybe')"
                                    :class="[
                                        'px-3 py-1 text-sm rounded-md transition-colors',
                                        getUserRSVP(event) === 'maybe'
                                            ? 'bg-yellow-500 text-white'
                                            : 'bg-gray-100 hover:bg-gray-200'
                                    ]">
                                {{ getUserRSVP(event) === 'maybe' ? '🤔 Maybe' : 'Maybe' }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <button @click="createMockEvent" 
                    class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">
                ➕ Create New Event
            </button>
        </div>

        <!-- Real-time Data Simulation -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">🔄 Real-time Data Sync Simulation</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-medium mb-2">Gun.js Data Patterns</h3>
                    <div class="text-sm space-y-1 font-mono">
                        <div>groups.{space}.{groupId}</div>
                        <div>events.{space}.{eventId}</div>
                        <div>users.{userPub}.eventHistory</div>
                        <div>events.{space}.{eventId}.attendees</div>
                        <div>events.{space}.{eventId}.waitlist</div>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-medium mb-2">Sync Status</h3>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                            <span class="text-sm">Groups: {{ mockGroups.length }} loaded</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                            <span class="text-sm">Events: {{ mockEvents.length }} loaded</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></span>
                            <span class="text-sm">Real-time updates: Active</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button @click="simulateRealTimeUpdate" 
                        class="px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600">
                    🔄 Simulate Real-time Update
                </button>
                <button @click="resetData" 
                        class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">
                    🗑️ Reset All Data
                </button>
            </div>
        </div>

        <!-- Test Results -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">🧪 Test Results</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-green-900 mb-2">✅ Completed Features</h3>
                    <ul class="text-sm text-green-700 space-y-1">
                        <li>• Query-param routing system</li>
                        <li>• Group management & categories</li>
                        <li>• Enhanced event system</li>
                        <li>• Real-time RSVP with waitlists</li>
                        <li>• Tailwind UI components</li>
                        <li>• Gun.js data patterns</li>
                    </ul>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-900 mb-2">🔄 In Progress</h3>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>• Location-based discovery</li>
                        <li>• Advanced search & filters</li>
                        <li>• Mobile responsiveness</li>
                        <li>• Performance optimization</li>
                    </ul>
                </div>

                <div class="bg-yellow-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-yellow-900 mb-2">⏳ Next Phase</h3>
                    <ul class="text-sm text-yellow-700 space-y-1">
                        <li>• Discussion threads</li>
                        <li>• Photo sharing</li>
                        <li>• Push notifications</li>
                        <li>• Analytics dashboard</li>
                        <li>• Mobile app integration</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="test-section">
            <h2 class="text-xl font-semibold mb-4">📝 Activity Log</h2>
            <div class="bg-gray-50 p-4 rounded-lg h-48 overflow-y-auto">
                <div v-for="(log, index) in activityLog" :key="index" 
                     :class="['text-sm mb-1', getLogColor(log.type)]">
                    <span class="font-mono text-xs text-gray-500">{{ formatTime(log.timestamp) }}</span>
                    {{ log.message }}
                </div>
                <div v-if="activityLog.length === 0" class="text-gray-500 text-sm">
                    No activity yet. Try interacting with the system above.
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                // Mock data
                const categories = ref([
                    { id: 'tech', name: 'Technology', icon: '💻', color: '#3B82F6' },
                    { id: 'business', name: 'Business', icon: '💼', color: '#10B981' },
                    { id: 'health', name: 'Health & Wellness', icon: '🏃‍♂️', color: '#F59E0B' },
                    { id: 'arts', name: 'Arts & Culture', icon: '🎨', color: '#EF4444' },
                    { id: 'social', name: 'Social', icon: '👥', color: '#8B5CF6' },
                    { id: 'learning', name: 'Learning', icon: '📚', color: '#06B6D4' }
                ]);

                const routes = ref([
                    { path: '/', name: 'events', component: 'Main', meta: { title: 'Events', icon: '📅' } },
                    { path: '/upcoming', name: 'upcoming', component: 'Main', meta: { title: 'Upcoming', icon: '⏰' } },
                    { path: '/groups', name: 'groups', component: 'GroupsView', meta: { title: 'Groups', icon: '👥' } },
                    { path: '/my-events', name: 'my-events', component: 'Main', meta: { title: 'My Events', icon: '👤' } },
                    { path: '/create', name: 'create', component: 'EventCreate', meta: { title: 'Create', icon: '➕' } },
                    { path: '/settings', name: 'settings', component: 'Settings', meta: { title: 'Settings', icon: '⚙️' } }
                ]);

                const mockGroups = ref([
                    {
                        id: 'group_1',
                        name: 'Vue.js Developers Seattle',
                        description: 'A community for Vue.js developers in the Seattle area',
                        category: 'tech',
                        location: { lat: 47.6062, lng: -122.3321, city: 'Seattle, WA', radius: 25 },
                        organizer: 'user_1',
                        members: ['user_1', 'user_2', 'user_3'],
                        memberCount: 3,
                        privacy: 'public',
                        tags: ['vuejs', 'frontend', 'javascript'],
                        createdAt: Date.now() - 86400000 * 30
                    },
                    {
                        id: 'group_2',
                        name: 'Startup Founders Network',
                        description: 'Connect with fellow entrepreneurs and startup founders',
                        category: 'business',
                        location: { lat: 47.6062, lng: -122.3321, city: 'Seattle, WA', radius: 15 },
                        organizer: 'user_2',
                        members: ['user_1', 'user_2'],
                        memberCount: 2,
                        privacy: 'private',
                        tags: ['startups', 'networking', 'entrepreneurship'],
                        createdAt: Date.now() - 86400000 * 15
                    }
                ]);

                const mockEvents = ref([
                    {
                        id: 'event_1',
                        groupId: 'group_1',
                        title: 'Vue 3 Composition API Workshop',
                        description: 'Deep dive into Vue 3 Composition API with hands-on examples',
                        date: new Date(Date.now() + 86400000 * 7).toISOString(),
                        time: '7:00 PM',
                        duration: 120,
                        status: 'published',
                        limit: 20,
                        attendees: {},
                        waitlist: [],
                        tags: ['workshop', 'vue3', 'composition-api'],
                        creator: 'user_1',
                        created: Date.now() - 86400000 * 2
                    },
                    {
                        id: 'event_2',
                        groupId: 'group_2',
                        title: 'Pitch Practice Session',
                        description: 'Practice your startup pitch and get feedback from fellow founders',
                        date: new Date(Date.now() + 86400000 * 3).toISOString(),
                        time: '6:00 PM',
                        duration: 90,
                        status: 'published',
                        limit: 10,
                        attendees: {},
                        waitlist: [],
                        tags: ['pitching', 'feedback', 'startups'],
                        creator: 'user_2',
                        created: Date.now() - 86400000 * 1
                    }
                ]);

                // Current user simulation
                const currentUser = ref({ 
                    pub: 'user_current', 
                    alias: 'Test User',
                    avatar: null 
                });

                // Router state
                const currentRoute = ref('/');
                const currentQuery = ref({});
                const activityLog = ref([]);

                // Methods
                const addToLog = (type, message) => {
                    activityLog.value.unshift({
                        type,
                        message,
                        timestamp: Date.now()
                    });
                    if (activityLog.value.length > 50) {
                        activityLog.value.pop();
                    }
                };

                const navigateToRoute = (route) => {
                    currentRoute.value = route.path;
                    currentQuery.value = {};
                    addToLog('info', `📍 Navigated to ${route.path} (${route.meta?.title})`);
                };

                const getCategoryIcon = (categoryId) => {
                    const cat = categories.value.find(c => c.id === categoryId);
                    return cat?.icon || '👥';
                };

                const getGroupName = (groupId) => {
                    const group = mockGroups.value.find(g => g.id === groupId);
                    return group?.name || 'Unknown Group';
                };

                const selectGroup = (group) => {
                    addToLog('success', `👥 Selected group: ${group.name} (${group.memberCount} members)`);
                };

                const createMockGroup = () => {
                    const newGroup = {
                        id: `group_${Date.now()}`,
                        name: `Test Group ${mockGroups.value.length + 1}`,
                        description: 'A test group created for demonstration',
                        category: 'social',
                        location: { lat: 47.6062, lng: -122.3321, city: 'Seattle, WA', radius: 10 },
                        organizer: currentUser.value.pub,
                        members: [currentUser.value.pub],
                        memberCount: 1,
                        privacy: 'public',
                        tags: ['test', 'demo'],
                        createdAt: Date.now()
                    };
                    mockGroups.value.unshift(newGroup);
                    addToLog('success', `✨ Created new group: ${newGroup.name}`);
                };

                const getEventAttending = (event) => {
                    return Object.values(event.attendees || {}).filter(a => a.status === 'attending').length;
                };

                const getEventWaitlist = (event) => {
                    return (event.waitlist || []).length;
                };

                const getUserRSVP = (event) => {
                    const attendee = event.attendees[currentUser.value.pub];
                    if (attendee) return attendee.status;
                    if (event.waitlist && event.waitlist.includes(currentUser.value.pub)) return 'waitlisted';
                    return null;
                };

                const rsvpToEvent = (event, status) => {
                    const currentRSVP = getUserRSVP(event);
                    
                    if (status === 'not_attending') {
                        // Remove from attendees and waitlist
                        delete event.attendees[currentUser.value.pub];
                        if (event.waitlist) {
                            event.waitlist = event.waitlist.filter(pub => pub !== currentUser.value.pub);
                        }
                        addToLog('warning', `❌ Cancelled RSVP for: ${event.title}`);
                    } else {
                        const attendingCount = getEventAttending(event);
                        
                        if (event.limit && attendingCount >= event.limit && status === 'attending') {
                            // Add to waitlist
                            if (!event.waitlist) event.waitlist = [];
                            if (!event.waitlist.includes(currentUser.value.pub)) {
                                event.waitlist.push(currentUser.value.pub);
                            }
                            // Remove from attendees if they were there
                            delete event.attendees[currentUser.value.pub];
                            addToLog('warning', `⏳ Added to waitlist for: ${event.title} (position #${event.waitlist.length})`);
                        } else {
                            // Add to attendees
                            event.attendees[currentUser.value.pub] = {
                                pub: currentUser.value.pub,
                                alias: currentUser.value.alias,
                                avatar: currentUser.value.avatar,
                                joinedAt: Date.now(),
                                status: status
                            };
                            // Remove from waitlist if they were there
                            if (event.waitlist) {
                                event.waitlist = event.waitlist.filter(pub => pub !== currentUser.value.pub);
                            }
                            
                            const statusEmoji = status === 'attending' ? '✅' : '🤔';
                            addToLog('success', `${statusEmoji} RSVP'd "${status}" for: ${event.title}`);
                        }
                    }
                };

                const createMockEvent = () => {
                    const newEvent = {
                        id: `event_${Date.now()}`,
                        groupId: mockGroups.value[0]?.id,
                        title: `Test Event ${mockEvents.value.length + 1}`,
                        description: 'A test event created for demonstration purposes',
                        date: new Date(Date.now() + 86400000 * Math.floor(Math.random() * 14) + 1).toISOString(),
                        time: '7:00 PM',
                        duration: 60,
                        status: 'published',
                        limit: Math.floor(Math.random() * 20) + 5,
                        attendees: {},
                        waitlist: [],
                        tags: ['test', 'demo'],
                        creator: currentUser.value.pub,
                        created: Date.now()
                    };
                    mockEvents.value.unshift(newEvent);
                    addToLog('success', `🎉 Created new event: ${newEvent.title}`);
                };

                const simulateRealTimeUpdate = () => {
                    const randomEvent = mockEvents.value[Math.floor(Math.random() * mockEvents.value.length)];
                    const randomUser = `user_${Math.floor(Math.random() * 10)}`;
                    
                    if (!randomEvent.attendees[randomUser]) {
                        randomEvent.attendees[randomUser] = {
                            pub: randomUser,
                            alias: `User ${randomUser}`,
                            avatar: null,
                            joinedAt: Date.now(),
                            status: Math.random() > 0.7 ? 'maybe' : 'attending'
                        };
                        addToLog('info', `🔄 Real-time: ${randomUser} RSVP'd to ${randomEvent.title}`);
                    }
                };

                const resetData = () => {
                    // Reset to original state
                    mockEvents.value.forEach(event => {
                        event.attendees = {};
                        event.waitlist = [];
                    });
                    activityLog.value = [];
                    addToLog('warning', '🗑️ All data has been reset');
                };

                const formatDate = (dateString) => {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric'
                    });
                };

                const formatTime = (timestamp) => {
                    return new Date(timestamp).toLocaleTimeString('en-US', {
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                };

                const getLogColor = (type) => {
                    const colors = {
                        success: 'success',
                        error: 'error', 
                        warning: 'warning',
                        info: 'text-blue-600'
                    };
                    return colors[type] || 'text-gray-600';
                };

                // Initialize
                onMounted(() => {
                    addToLog('success', '🚀 Event Plugin System Test initialized');
                    addToLog('info', `📊 Loaded ${mockGroups.value.length} groups and ${mockEvents.value.length} events`);
                });

                return {
                    categories,
                    routes,
                    mockGroups,
                    mockEvents,
                    currentUser,
                    currentRoute,
                    currentQuery,
                    activityLog,
                    navigateToRoute,
                    getCategoryIcon,
                    getGroupName,
                    selectGroup,
                    createMockGroup,
                    getEventAttending,
                    getEventWaitlist,
                    getUserRSVP,
                    rsvpToEvent,
                    createMockEvent,
                    simulateRealTimeUpdate,
                    resetData,
                    formatDate,
                    formatTime,
                    getLogColor
                };
            }
        }).mount('#app');
    </script>
</body>
</html>